#! Generated by VisualDCT v2.5
#! DBDSTART
#! DBD("../../dbd/pmacUtil.dbd")
#! DBDEND

######## MACROS ###########
# SYS:	PV system name - same as for motor record
# DEV:	PV device name - same as for motor record
# PORT: asyn port name to the PMAC (for instance PMAC_S0)
# AXIS: PMAC axis number to request the status word for

record(ai, "$(SYS)$(DEV)PhaseCur-I") {
  field(DESC, "actual motor current readback")
  field(PINI, "1")
  field(DTYP, "stream")
  field(INP, "@pmac.proto getCurrent_RDB(M$(AXIS)76) $(PORT)")
  field(PREC, "1")
  field(EGU, "mA")
  field(LOPR,"0.1")
  field(HOPR,"2.00")
  field(SCAN, "1 second")
}

record(bi, "$(SYS)$(DEV)AxisEnable-Sts") {
  field(SCAN, "1 second")
  field(PINI, "YES")
  field(DTYP, "stream")
  field(INP, "@pmac.proto getAmplifierStat(M$(AXIS)39) $(PORT)")
  field(ZNAM, "Disabled")
  field(ONAM, "Enabled")
}

# Read the status ? from the pmac for axes no $(AXIS)
record(asyn, "$(SYS)$(DEV)Sts-Asyn_") {
  field(DESC, "get motor status")
  field(SCAN, "Passive")
  field(PINI, "YES")
  field(PORT, "$(PORT)")
  field(OFMT, "ASCII")
  field(IFMT, "ASCII")
  field(FLNK, "$(SYS)$(DEV)Sts:1-FOut_")
}

record(fanout, "$(SYS)$(DEV)Sts:1-FOut_") {
  field(FLNK, "$(SYS)$(DEV)Sts:1-SCalcout_")
  field(LNK1, "$(SYS)$(DEV)Sts:2-SCalcout_")
}

record(scalcout, "$(SYS)$(DEV)Sts:1-SCalcout_") {
  field(DESC, "parse status for X")
  field(SCAN, "Passive")
  field(DTYP, "Soft Channel")
  field(INAA, "$(SYS)$(DEV)Sts-Asyn_.TINP PP MS")
  field(OUT, "$(SYS)$(DEV)Sts:1_2-FOut_.VAL PP")
  field(OOPT, "On Change")
  field(DOPT, "Use CALC")
  field(CALC, "SSCANF(AA, '%*6X%6X')")
}

record(scalcout, "$(SYS)$(DEV)Sts:2-SCalcout_") {
  field(DESC, "parse status for X")
  field(SCAN, "Passive")
  field(DTYP, "Soft Channel")
  field(INAA, "$(SYS)$(DEV)Sts-Asyn_.TINP PP MS")
  field(OUT, "$(SYS)$(DEV)Sts:3_4-FOut_.VAL PP")
  field(OOPT, "On Change")
  field(DOPT, "Use CALC")
  field(CALC, "SSCANF(AA, '%6X%*6X')")
}

record(dfanout, "$(SYS)$(DEV)Sts:3_4-FOut_") {
  field(OUTA, "$(SYS)$(DEV)Sts:3-Sts.RVAL PP")
  field(OUTB, "$(SYS)$(DEV)Sts:4-Sts.RVAL PP")
}

record(dfanout, "$(SYS)$(DEV)Sts:1_2-FOut_") {
  field(OUTA, "$(SYS)$(DEV)Sts:1-Sts.RVAL PP")
  field(OUTB, "$(SYS)$(DEV)Sts:2-Sts.RVAL PP")
}

record(mbbiDirect, "$(SYS)$(DEV)Sts:1-Sts") {
  field(DESC, "status lower bits 1-12")
  field(SCAN, "Passive")
  field(DTYP, "Raw Soft Channel")
  field(NOBT, "12")
  field(SHFT, "0")
}

record(mbbiDirect, "$(SYS)$(DEV)Sts:2-Sts") {
  field(DESC, "status bits 13-24")
  field(SCAN, "Passive")
  field(DTYP, "Raw Soft Channel")
  field(NOBT, "12")
  field(SHFT, "12")
}

record(mbbiDirect, "$(SYS)$(DEV)Sts:3-Sts") {
  field(DESC, "status bits 25-36")
  field(SCAN, "Passive")
  field(DTYP, "Raw Soft Channel")
  field(NOBT, "12")
  field(SHFT, "0")
}

record(mbbiDirect, "$(SYS)$(DEV)Sts:4-Sts") {
  field(DESC, "status bits 37-48")
  field(SCAN, "Passive")
  field(DTYP, "Raw Soft Channel")
  field(NOBT, "12")
  field(SHFT, "12")
}

# Put together the axis number to form the #xx? command
record(scalcout, "$(SYS)$(DEV)Sts-SCalcout_") {
  field(DESC, "create the pmac cmd")
  field(FLNK, "$(SYS)$(DEV)Sts-Asyn_")
  field(CALC, "PRINTF('#%d?',A)")
  field(INPA, "$(SYS)$(DEV)Cnt:Ax-SP")
  field(OUT, "$(SYS)$(DEV)Sts-Asyn_.AOUT PP")
  field(OOPT, "Every Time")
  field(DOPT, "Use CALC")
  field(SCAN, "1 second")
}

record(ao, "$(SYS)$(DEV)Cnt:Ax-SP") {
  field(DESC, "PMAC Axis number")
  field(PINI, "YES")
  field(DTYP, "Soft Channel")
  field(FLNK, "$(SYS)$(DEV)Sts-SCalcout_")
  field(VAL, "$(AXIS)")
  field(PREC, "0")
  field(LINR, "NO CONVERSION")
  field(HOPR, "32")
  field(LOPR, "1")
}

record(mbbi, "$(SYS)$(DEV)Sts:HomeCmplt-Sts_") {
  field(DESC, "Home complete bit extraction")
  field(PINI, "YES")
  field(SCAN, "Passive")
  field(DTYP, "Raw Soft Channel")
  field(INP,  "$(SYS)$(DEV)Sts:1-Sts CPP")
  field(NOBT, "1")
  field(SHFT, "10")
  field(FLNK, "$(SYS)$(DEV)Sts:HomeCmplt-Sts")
}

record(bi, "$(SYS)$(DEV)Sts:HomeCmplt-Sts") {
  field(DESC, "Home complete status")
  field(PINI, "NO")
  field(SCAN, "Passive")
  field(DTYP, "Soft Channel")
  field(INP,  "$(SYS)$(DEV)Sts:HomeCmplt-Sts_")
  field(ZNAM, "Not homed")
  field(ONAM, "Homed")
  field(ZSV,  "MINOR")
  field(OSV,  "NO_ALARM")
}

#! Further lines contain data used by VisualDCT
#! View(42,1308,1.2)
#! Record("$(SYS)$(DEV)Sts-Asyn_",480,1543,0,0,"$(SYS)$(DEV)Sts-Asyn_")
#! Field("$(SYS)$(DEV)Sts-Asyn_.TINP",16777215,1,"$(SYS)$(DEV)Sts-Asyn_.TINP")
#! Field("$(SYS)$(DEV)Sts-Asyn_.FLNK",16777215,1,"$(SYS)$(DEV)Sts-Asyn_.FLNK")
#! Link("$(SYS)$(DEV)Sts-Asyn_.FLNK","$(SYS)$(DEV)Sts:1-FOut_")
#! Field("$(SYS)$(DEV)Sts-Asyn_.AOUT",16777215,0,"$(SYS)$(DEV)Sts-Asyn_.AOUT")
#! Record("$(SYS)$(DEV)Sts:1-FOut_",780,1535,0,0,"$(SYS)$(DEV)Sts:1-FOut_")
#! Field("$(SYS)$(DEV)Sts:1-FOut_.FLNK",16777215,1,"$(SYS)$(DEV)Sts:1-FOut_.FLNK")
#! Field("$(SYS)$(DEV)Sts:1-FOut_.LNK1",16777215,1,"$(SYS)$(DEV)Sts:1-FOut_.LNK1")
#! Link("$(SYS)$(DEV)Sts:1-FOut_.LNK1","$(SYS)$(DEV)Sts:2-SCalcout_")
#! Record("$(SYS)$(DEV)Sts:1-SCalcout_",1140,1288,0,0,"$(SYS)$(DEV)Sts:1-SCalcout_")
#! Field("$(SYS)$(DEV)Sts:1-SCalcout_.INAA",16777215,0,"$(SYS)$(DEV)Sts:1-SCalcout_.INAA")
#! Link("$(SYS)$(DEV)Sts:1-SCalcout_.INAA","$(SYS)$(DEV)Sts-Asyn_.TINP")
#! Field("$(SYS)$(DEV)Sts:1-SCalcout_.OUT",16777215,1,"$(SYS)$(DEV)Sts:1-SCalcout_.OUT")
#! Link("$(SYS)$(DEV)Sts:1-SCalcout_.OUT","$(SYS)$(DEV)Sts:2-FOut_.VAL")
#! Record("$(SYS)$(DEV)Sts:2-SCalcout_",1120,1688,0,0,"$(SYS)$(DEV)Sts:2-SCalcout_")
#! Field("$(SYS)$(DEV)Sts:2-SCalcout_.INAA",16777215,0,"$(SYS)$(DEV)Sts:2-SCalcout_.INAA")
#! Field("$(SYS)$(DEV)Sts:2-SCalcout_.OUT",16777215,1,"$(SYS)$(DEV)Sts:2-SCalcout_.OUT")
#! Link("$(SYS)$(DEV)Sts:2-SCalcout_.OUT","$(SYS)$(DEV)Sts:3-FOut_.VAL")
#! Record("$(SYS)$(DEV)Sts:3-FOut_",1440,1615,0,1,"$(SYS)$(DEV)Sts:3-FOut_")
#! Field("$(SYS)$(DEV)Sts:3-FOut_.OUTA",16777215,1,"$(SYS)$(DEV)Sts:3-FOut_.OUTA")
#! Link("$(SYS)$(DEV)Sts:3-FOut_.OUTA","$(SYS)$(DEV)Sts:3-Sts.RVAL")
#! Field("$(SYS)$(DEV)Sts:3-FOut_.OUTB",16777215,1,"$(SYS)$(DEV)Sts:3-FOut_.OUTB")
#! Link("$(SYS)$(DEV)Sts:3-FOut_.OUTB","$(SYS)$(DEV)Sts:4-Sts.RVAL")
#! Field("$(SYS)$(DEV)Sts:3-FOut_.VAL",16777215,0,"$(SYS)$(DEV)Sts:3-FOut_.VAL")
#! Record("$(SYS)$(DEV)Sts:2-FOut_",1440,1215,0,1,"$(SYS)$(DEV)Sts:2-FOut_")
#! Field("$(SYS)$(DEV)Sts:2-FOut_.VAL",16777215,0,"$(SYS)$(DEV)Sts:2-FOut_.VAL")
#! Field("$(SYS)$(DEV)Sts:2-FOut_.OUTA",16777215,1,"$(SYS)$(DEV)Sts:2-FOut_.OUTA")
#! Link("$(SYS)$(DEV)Sts:2-FOut_.OUTA","$(SYS)$(DEV)Sts:1-Sts.RVAL")
#! Field("$(SYS)$(DEV)Sts:2-FOut_.OUTB",16777215,1,"$(SYS)$(DEV)Sts:2-FOut_.OUTB")
#! Record("$(SYS)$(DEV)Sts:1-Sts",1800,1191,0,1,"$(SYS)$(DEV)Sts:1-Sts")
#! Field("$(SYS)$(DEV)Sts:1-Sts.RVAL",16777215,0,"$(SYS)$(DEV)Sts:1-Sts.RVAL")
#! Record("$(SYS)$(DEV)Sts:2-Sts",1800,1391,0,1,"$(SYS)$(DEV)Sts:2-Sts")
#! Field("$(SYS)$(DEV)Sts:2-Sts.RVAL",16777215,0,"$(SYS)$(DEV)Sts:2-Sts.RVAL")
#! Record("$(SYS)$(DEV)Sts:3-Sts",1800,1571,0,1,"$(SYS)$(DEV)Sts:3-Sts")
#! Field("$(SYS)$(DEV)Sts:3-Sts.RVAL",16777215,0,"$(SYS)$(DEV)Sts:3-Sts.RVAL")
#! Record("$(SYS)$(DEV)Sts:4-Sts",1800,1771,0,1,"$(SYS)$(DEV)Sts:4-Sts")
#! Field("$(SYS)$(DEV)Sts:4-Sts.RVAL",16777215,0,"$(SYS)$(DEV)Sts:4-Sts.RVAL")
#! Record("$(SYS)$(DEV)Cmd-SCalcout_",80,1623,0,0,"$(SYS)$(DEV)Cmd-SCalcout_")
#! Field("$(SYS)$(DEV)Cmd-SCalcout_.INPA",16777215,1,"$(SYS)$(DEV)Cmd-SCalcout_.INPA")
#! Link("$(SYS)$(DEV)Cmd-SCalcout_.INPA","$(SYS)$(DEV)Cnt:Ax-SP.VAL")
#! Field("$(SYS)$(DEV)Cmd-SCalcout_.OUT",16777215,1,"$(SYS)$(DEV)Cmd-SCalcout_.OUT")
#! Link("$(SYS)$(DEV)Cmd-SCalcout_.OUT","$(SYS)$(DEV)Sts-Asyn_.AOUT")
#! Field("$(SYS)$(DEV)Cmd-SCalcout_.FLNK",16777215,1,"$(SYS)$(DEV)Cmd-SCalcout_.FLNK")
#! Link("$(SYS)$(DEV)Cmd-SCalcout_.FLNK","$(SYS)$(DEV)Sts-Asyn_")
#! Record("$(SYS)$(DEV)Cnt:Ax-SP",120,1334,0,1,"$(SYS)$(DEV)Cnt:Ax-SP")
#! Field("$(SYS)$(DEV)Cnt:Ax-SP.FLNK",16777215,0,"$(SYS)$(DEV)Cnt:Ax-SP.FLNK")
#! Link("$(SYS)$(DEV)Cnt:Ax-SP.FLNK","$(SYS)$(DEV)Cmd-SCalcout_")
#! Field("$(SYS)$(DEV)Cnt:Ax-SP.VAL",16777215,1,"$(SYS)$(DEV)Cnt:Ax-SP.VAL")
#! Box(Box0,20,1140,2280,2000,0,3355647,null)
#! TextBox(TB4,1120,1620,1380,1660,1,"Dialog",12,1,16777215,"Motor Activated ... Maximum Rapid Speed",null)
#! TextBox(TB3,1980,1620,2160,1680,1,"Dialog",12,1,16777215,"B0: Maximum rapid speed\nBB: Block request",null)
#! TextBox(TB2,1980,1440,2220,1500,1,"Dialog",12,1,16777215,"B0: Stopped on desired position limit\nBB: C.S.-1 Number (MSB)",null)
#! TextBox(TB1,440,1160,900,1340,1,"Dialog",12,1,16777215,"This section is to collect the status word from the 3 PMAC axes.\nThe asyn record $(SYS)$(DEV)Sts-Asyn_ sends out a '#$(AXIS)?' command\nto the PMAC and receives the response. \n\nThe scalcout records parses the input into 24bit words \n(as EPICS can't seem to handle the whole 48 bit words).\n\nFinally the mbbiDirect record parses each a 12 bit word and the status\nbits of each axis can be read out from the B0..BB fields of the mbbiDirect\nrecords.",null)
#! TextBox(TB0,1980,1220,2180,1280,1,"Dialog",12,1,16777215,"B0: In Position\nBB: Stopped on position limit",null)
#! TextBox(TB8,780,1120,1280,1000,0,"Dialog",12,1,16777215,"              ######## MACROS ###########\nP:     PV base name\nR:     PV postfix\nPORT:  asyn port name to the PMAC (for instance PMAC_S0)\nAXIS:  PMAC axis number to request the status word for",null)
#! TextBox(TB7,3540,2240,3720,2280,0,"Dialog",12,1,16777215,"Readbacks",null)
#! TextBox(TB6,1980,1800,2180,1860,1,"Dialog",12,1,16777215,"B0: Abort deceleration\nBB: Motor activated",null)
#! TextBox(TB5,1100,1240,1360,1280,1,"Dialog",12,1,16777215,"(C.S. -1) Number (MSB) ... In Position",null)
